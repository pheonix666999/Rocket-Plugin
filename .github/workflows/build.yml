name: Build The Rocket Plugin

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build_windows:
    name: Build Windows (VST3, Standalone)
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Checkout JUCE (8.0.12)
      uses: actions/checkout@v4
      with:
        repository: juce-framework/JUCE
        ref: 8.0.12
        path: JUCE
        fetch-depth: 1
        
    - name: Configure CMake
      # Build in RocketRemake/build_win, Source in RocketRemake
      # Pass JUCE_DIR explicitly
      shell: pwsh
      run: |
        $juce = Join-Path $env:GITHUB_WORKSPACE 'JUCE'
        if (!(Test-Path $juce)) { throw "JUCE folder missing at $juce" }
        cmake -S RocketRemake -B RocketRemake/build_win -G "Visual Studio 17 2022" -A x64 -DJUCE_DIR="$juce"
      
    - name: Build Release
      shell: pwsh
      run: |
        cmake --build RocketRemake/build_win --config Release --target TheRocket_VST3 TheRocket_Standalone --parallel 4
      
    - name: Prepare Artifacts
      shell: bash
      run: |
        mkdir -p dist/Windows
        cp -r RocketRemake/build_win/TheRocket_artefacts/Release/VST3/*.vst3 dist/Windows/ 2>/dev/null || :
        cp -r RocketRemake/build_win/TheRocket_artefacts/Release/Standalone/*.exe dist/Windows/ 2>/dev/null || :
      
    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TheRocket-Windows
        path: dist/Windows

  build_macos:
    name: Build macOS (AU, VST3, Standalone)
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Checkout JUCE (8.0.12)
      uses: actions/checkout@v4
      with:
        repository: juce-framework/JUCE
        ref: 8.0.12
        path: JUCE
        fetch-depth: 1
        
    - name: Configure CMake
      # Build Universal Binary (Intel + Apple Silicon)
      run: cmake -S RocketRemake -B RocketRemake/build_mac -G Xcode -DJUCE_DIR="${{ github.workspace }}/JUCE" -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
      
    - name: Build Release
      run: cmake --build RocketRemake/build_mac --config Release --target TheRocket_AU TheRocket_VST3 TheRocket_Standalone --parallel 4
      
    - name: Prepare Artifacts
      run: |
        mkdir -p dist/macOS
        cp -R RocketRemake/build_mac/TheRocket_artefacts/Release/VST3/*.vst3 dist/macOS/ 2>/dev/null || :
        cp -R RocketRemake/build_mac/TheRocket_artefacts/Release/AU/*.component dist/macOS/ 2>/dev/null || :
        cp -R RocketRemake/build_mac/TheRocket_artefacts/Release/Standalone/*.app dist/macOS/ 2>/dev/null || :
        
    - name: Upload macOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TheRocket-macOS
        path: dist/macOS
